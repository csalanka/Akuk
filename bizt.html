("utf-8").decode(data);
                    const rows = text.trim().split("\n").map(row => row.split(","));
                    parseCSVRows(rows);
                } catch (error) {
                    alert('Hiba t√∂rt√©nt a CSV f√°jl beolvas√°sakor: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseCSVRows(rows) {
            if (!rows.length || !rows[0].length) {
                alert("A CSV f√°jl √©rv√©nytelen vagy √ºres.");
                return;
            }

            const newDevices = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length === 0 || (row.length === 1 && row[0] === '')) continue;

                const batteryCountValue = parseInt(row[4]);
                const device = {
                    id: row[0] || `ESZ${String(i).padStart(3, '0')}`,
                    name: row[1] || 'N√©vtelen eszk√∂z',
                    location: row[2] || 'Ismeretlen',
                    batteryType: row[3] || 'Egy√©b',
                    // JAV√çT√ÅS: batteryCount alap√©rtelmezett √©rt√©ke 0, ha a parseint NaN vagy falsy
                    batteryCount: isNaN(batteryCountValue) ? 0 : batteryCountValue,
                    chargerType: row[5] || 'Egy√©b',
                    usageFrequency: row[6] || '',
                    lastCharge: row[7] || null,
                    notes: row[8] || ''
                };
                newDevices.push(device);
            }

            if (newDevices.length === 0) {
                alert('Nem siker√ºlt egyetlen eszk√∂zt sem beolvasni!');
                return;
            }

            if (devices.length > 0) {
                if (!confirm(`${newDevices.length} eszk√∂z lesz bet√∂ltve. Ez fel√ºl√≠rja a jelenlegi ${devices.length} eszk√∂zt. Folytatod?`)) {
                    return;
                }
            }

            devices = newDevices;
            renderTable();
            document.getElementById('csvFileInput').value = '';
            alert(`‚úÖ ${newDevices.length} eszk√∂z sikeresen bet√∂ltve!`);
        }

        function exportBatteryCSV() {
            if (batteries.length === 0) {
                alert('Nincsenek akkumul√°torok!');
                return;
            }

            // √öJ FEJL√âC AZ √öJ MEZ≈êKHOZ
            const headers = ['AkkuID', 'Tipus', 'Belso_ellenallas_mO', 'Kapacitas_mAh', 'Gyari_Kapacitas_mAh', 'Hozzaendelt_EszkozID', 'Felhasznalasi_szam', 'Minosites', 'Utolso_toltes'];
            let csvContent = headers.join(',') + '\n';
            
            batteries.forEach(battery => {
                const row = [
                    battery.id || '',
                    battery.type || '',
                    battery.internalResistance || 0,
                    battery.capacity || 0,
                    battery.nominalCapacity || 0, // √öJ MEZ≈ê EXPORT√ÅL√ÅSA
                    battery.assignedToDeviceId || '', // √öJ MEZ≈ê EXPORT√ÅL√ÅSA
                    battery.usageCount || 0,
                    battery.quality || '',
                    battery.lastCharge || ''
                ];
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/plain;charset=ascii' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `akkumulator_v2_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            alert('‚úÖ Akkumul√°tor CSV export√°lva!');
        }

        function showBatteryCSVText() {
            if (batteries.length === 0) {
                alert('Nincsenek akkumul√°torok!');
                return;
            }

            // √öJ FEJL√âC AZ √öJ MEZ≈êKHOZ
            const headers = ['AkkuID', 'Tipus', 'Belso_ellenallas_mO', 'Kapacitas_mAh', 'Gyari_Kapacitas_mAh', 'Hozzaendelt_EszkozID', 'Felhasznalasi_szam', 'Minosites', 'Utolso_toltes'];
            let csvText = headers.join(',') + '\n';
            
            batteries.forEach(battery => {
                const row = [
                    battery.id || '',
                    battery.type || '',
                    battery.internalResistance || 0,
                    battery.capacity || 0,
                    battery.nominalCapacity || 0, // √öJ MEZ≈ê
                    battery.assignedToDeviceId || '', // √öJ MEZ≈ê
                    battery.usageCount || 0,
                    battery.quality || '',
                    battery.lastCharge || ''
                ];
                csvText += row.join(',') + '\n';
            });

            const textWindow = window.open('', '_blank', 'width=800,height=600');
            textWindow.document.write(`
                <html>
                <head><title>Akkumul√°tor CSV Export v2.5.1</title></head> <body style="font-family: Arial; padding: 20px;">
                    <h3>Akkumul√°tor CSV Export - ${batteries.length} akku</h3>
                    <p>M√°sold ki az al√°bbi sz√∂veget:</p>
                    <textarea style="width: 100%; height: 400px; font-family: monospace;">${csvText}</textarea>
                    <br><br>
                    <button onclick="navigator.clipboard.writeText(document.querySelector('textarea').value).then(() => alert('V√°g√≥lapra m√°solva!')).catch(() => alert('Jel√∂ld ki √©s m√°sold manu√°lisan!'))">üìã V√°g√≥lapra</button>
                </body>
                </html>
            `);
        }

        function loadBatteryCSV() {
            const fileInput = document.getElementById('batteryCSVInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('K√©rlek, v√°lassz ki egy CSV f√°jlt!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const text = new TextDecoder("utf-8").decode(data);
                    const rows = text.trim().split("\n").map(row => row.split(","));
                    parseBatteryCSVRows(rows);
                } catch (error) {
                    alert('Hiba t√∂rt√©nt az akkumul√°tor CSV f√°jl beolvas√°sakor: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseBatteryCSVRows(rows) {
            if (!rows.length || !rows[0].length) {
                alert("Az akkumul√°tor CSV f√°jl √©rv√©nytelen vagy √ºres.");
                return;
            }

            const newBatteries = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length === 0 || (row.length === 1 && row[0] === '')) continue;

                const battery = {
                    id: row[0] || `AK${String(i).padStart(3, '0')}`,
                    type: row[1] || 'Li-ion_18V',
                    internalResistance: parseFloat(row[2]) || 0,
                    capacity: parseInt(row[3]) || 0,
                    nominalCapacity: parseInt(row[4]) || 0, // INDEX 4
                    assignedToDeviceId: row[5] || '', // INDEX 5
                    usageCount: parseInt(row[6]) || 0, // INDEX 6
                    quality: row[7] || 'Kiv√°l√≥',       // INDEX 7
                    lastCharge: row[8] || null         // INDEX 8
                };
                newBatteries.push(battery);
            }

            if (newBatteries.length === 0) {
                alert('Nem siker√ºlt egyetlen akkumul√°tort sem beolvasni!');
                return;
            }

            if (batteries.length > 0) {
                if (!confirm(`${newBatteries.length} akkumul√°tor lesz bet√∂ltve. Ez fel√ºl√≠rja a jelenlegi ${batteries.length} akkumul√°tort. Folytatod?`)) {
                    return;
                }
            }

            batteries = newBatteries;
            renderBatteryTable();
            document.getElementById('batteryCSVInput').value = '';
            alert(`‚úÖ ${newBatteries.length} akkumul√°tor sikeresen bet√∂ltve!`);
        }

        function toggleFullscreen() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    fullscreenBtn.innerHTML = '‚õ∂'; // V√°ltoztasd az ikont, ha be van kapcsolva
                    fullscreenBtn.title = 'Norm√°l n√©zet';
                }).catch(err => {
                    alert('Nem siker√ºlt teljes k√©perny≈ëre v√°ltani: ' + err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    fullscreenBtn.innerHTML = '‚õ∂'; // V√°ltoztasd az ikont, ha ki van kapcsolva
                    fullscreenBtn.title = 'Teljes k√©perny≈ë';
                }).catch(err => {
                    alert('Nem siker√ºlt kil√©pni a teljes k√©perny≈ër≈ël: ' + err);
                });
            }
        }

        document.addEventListener('fullscreenchange', () => {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (!document.fullscreenElement) {
                fullscreenBtn.innerHTML = '‚õ∂'; // V√°ltoztasd az ikont, ha ki van kapcsolva
                fullscreenBtn.title = 'Teljes k√©perny≈ë';
            } else {
                fullscreenBtn.innerHTML = '‚õ∂'; // V√°ltoztasd az ikont, ha be van kapcsolva
                fullscreenBtn.title = 'Norm√°l n√©zet';
            }
        });

        window.onclick = function(event) {
            const deviceModal = document.getElementById('deviceModal');
            const batteryModal = document.getElementById('batteryModal');
            if (event.target === deviceModal) {
                closeModal();
            }
            if (event.target === batteryModal) {
                closeBatteryModal();
            }
        }
    </script>
</body>
</html>
